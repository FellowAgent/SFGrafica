// This file is automatically generated. Do not edit it directly.
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Chave para armazenar configura√ß√£o din√¢mica no localStorage
const DYNAMIC_CONFIG_KEY = 'supabase_dynamic_config';

// Interface para configura√ß√£o din√¢mica
interface DynamicConfig {
  supabaseUrl?: string;
  supabaseAnonKey?: string;
  supabaseServiceRoleKey?: string;
  projectId?: string;
  destinationDatabaseUrl?: string;
  timestamp?: number;
}

// Fun√ß√£o para obter configura√ß√£o do localStorage
function getDynamicConfig(): DynamicConfig | null {
  if (typeof window === 'undefined') return null;
  
  try {
    const stored = localStorage.getItem(DYNAMIC_CONFIG_KEY);
    if (stored) {
      const config = JSON.parse(stored) as DynamicConfig;
      // Configura√ß√£o v√°lida por 24 horas
      if (config.timestamp && Date.now() - config.timestamp < 24 * 60 * 60 * 1000) {
        return config;
      }
    }
  } catch (e) {
    console.warn('Erro ao ler configura√ß√£o din√¢mica:', e);
  }
  
  return null;
}

// Fun√ß√£o para salvar configura√ß√£o din√¢mica
export function setDynamicSupabaseConfig(
  url: string,
  anonKey: string,
  projectId?: string,
  serviceRoleKey?: string,
  destinationDatabaseUrl?: string
) {
  if (typeof window === 'undefined') return;
  
  const config: DynamicConfig = {
    supabaseUrl: url.trim(),
    supabaseAnonKey: anonKey.trim(),
    supabaseServiceRoleKey: serviceRoleKey?.trim() || undefined,
    projectId,
    destinationDatabaseUrl: destinationDatabaseUrl?.trim() || undefined,
    timestamp: Date.now(),
  };
  
  try {
    localStorage.setItem(DYNAMIC_CONFIG_KEY, JSON.stringify(config));
    console.log('‚úÖ Configura√ß√£o din√¢mica do Supabase salva!');
    console.log('‚ö†Ô∏è Recarregue a p√°gina para aplicar as mudan√ßas.');
  } catch (e) {
    console.error('Erro ao salvar configura√ß√£o din√¢mica:', e);
  }
}

// Fun√ß√£o para limpar configura√ß√£o din√¢mica
export function clearDynamicSupabaseConfig() {
  if (typeof window === 'undefined') return;
  localStorage.removeItem(DYNAMIC_CONFIG_KEY);
  console.log('‚úÖ Configura√ß√£o din√¢mica removida. Usando vari√°veis de ambiente.');
}

// Fun√ß√£o para obter as vari√°veis de ambiente (com fallback para configura√ß√£o din√¢mica)
function getEnvVars() {
  // Primeiro, tentar usar configura√ß√£o din√¢mica do localStorage
  const dynamicConfig = getDynamicConfig();
  if (dynamicConfig?.supabaseUrl && dynamicConfig?.supabaseAnonKey) {
    console.log('üì¶ Usando configura√ß√£o din√¢mica do Supabase');
    return {
      projectId: dynamicConfig.projectId,
      supabaseUrl: dynamicConfig.supabaseUrl,
      supabaseAnonKey: dynamicConfig.supabaseAnonKey,
    };
  }
  
  // Fallback para vari√°veis de ambiente
  const projectId = import.meta.env.VITE_SUPABASE_PROJECT_ID as string | undefined;
  const configuredUrl = import.meta.env.VITE_SUPABASE_URL as string | undefined;
  const supabaseUrl = configuredUrl?.trim() || (projectId ? `https://${projectId}.supabase.co` : undefined);
  const supabaseAnonKey = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY as string | undefined;
  
  return { projectId, supabaseUrl, supabaseAnonKey };
}

// Fun√ß√£o para criar o cliente Supabase
function createSupabaseClient(): SupabaseClient<Database> {
  const { supabaseUrl, supabaseAnonKey } = getEnvVars();

  if (!supabaseUrl) {
    throw new Error(
      'Supabase URL not configured. Set VITE_SUPABASE_URL or VITE_SUPABASE_PROJECT_ID in your environment.'
    );
  }

  if (!supabaseAnonKey) {
    throw new Error(
      'Supabase anon key not configured. Set VITE_SUPABASE_PUBLISHABLE_KEY in your environment.'
    );
  }

  return createClient<Database>(supabaseUrl, supabaseAnonKey, {
    auth: {
      storage: typeof window !== 'undefined' ? localStorage : undefined,
      persistSession: true,
      autoRefreshToken: true,
    },
  } as any);
}

// Cliente padr√£o (criado na inicializa√ß√£o)
let supabaseInstance: SupabaseClient<Database> | null = null;
let lastConfigHash: string | null = null;

// Fun√ß√£o para gerar hash da configura√ß√£o atual
function getConfigHash(): string {
  const vars = getEnvVars();
  const dynamicConfig = getDynamicConfig();
  return JSON.stringify({
    url: vars.supabaseUrl,
    key: vars.supabaseAnonKey ? '***' : null, // N√£o incluir a chave completa por seguran√ßa
    dynamic: !!dynamicConfig,
    dynamicUrl: dynamicConfig?.supabaseUrl,
  });
}

// Fun√ß√£o para obter ou recriar o cliente
export function getSupabaseClient(): SupabaseClient<Database> {
  const currentConfigHash = getConfigHash();
  const currentVars = getEnvVars();
  
  // Sempre verificar se a configura√ß√£o mudou
  if (!supabaseInstance || lastConfigHash !== currentConfigHash) {
    console.log('üîÑ Criando/Recriando cliente Supabase...');
    console.log('üìã Configura√ß√£o:', {
      url: currentVars.supabaseUrl,
      hasKey: !!currentVars.supabaseAnonKey,
      hasDynamicConfig: !!getDynamicConfig(),
    });
    
    supabaseInstance = createSupabaseClient();
    lastConfigHash = currentConfigHash;
    
    console.log('‚úÖ Cliente Supabase criado com URL:', currentVars.supabaseUrl);
  }
  
  return supabaseInstance;
}

// Criar um Proxy para o cliente que sempre retorna a inst√¢ncia atualizada
const supabaseProxy = new Proxy({} as SupabaseClient<Database>, {
  get(_target, prop) {
    const client = getSupabaseClient();
    const value = (client as any)[prop];
    
    // Se for uma fun√ß√£o, bind para o cliente atual
    if (typeof value === 'function') {
      return value.bind(client);
    }
    
    return value;
  },
  set(_target, prop, value) {
    const client = getSupabaseClient();
    (client as any)[prop] = value;
    return true;
  },
});

// Exportar o cliente via Proxy (sempre atualizado)
export const supabase = supabaseProxy as SupabaseClient<Database>;

// Fun√ß√£o para for√ßar recria√ß√£o do cliente (√∫til ap√≥s mudan√ßas no .env)
export function recreateSupabaseClient(): SupabaseClient<Database> {
  console.log('üîÑ For√ßando recria√ß√£o do cliente Supabase...');
  supabaseInstance = null;
  lastConfigHash = null;
  return getSupabaseClient();
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Re-export admin client functions for convenience
export { getSupabaseAdminClient, recreateAdminClient, isAdminClientAvailable } from './adminClient';